<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>My Profile | Financial Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root { --primary-color: #4361ee; --secondary-color: #3a0ca3; --light-color: #f8f9fa; }
        body { background-color: var(--light-color); font-family: 'Segoe UI', sans-serif; padding: 20px 0; }
        .profile-container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .profile-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 2rem; text-align: center; }
        .profile-picture { width: 150px; height: 150px; border-radius: 50%; border: 5px solid white; margin: 0 auto 1rem; background-color: #ddd; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer; }
        .profile-picture img { width: 100%; height: 100%; object-fit: cover; }
        .profile-picture i { font-size: 3.5rem; color: #777; }
        .profile-body { padding: 2rem; }
        .form-section { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid #eee; }
        .form-section:last-of-type { border-bottom: none; }
        .section-title { color: var(--primary-color); margin-bottom: 1.5rem; font-weight: 600; display: flex; align-items: center; }
        .section-title i { margin-right: 10px; font-size: 1.2rem; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--secondary-color); border-color: var(--secondary-color); }
        .action-buttons { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-picture" id="profilePicture">
                    <i class="fas fa-user"></i>
                    <input type="file" id="profileImage" accept="image/*" style="display: none;" />
                </div>
                <h1 id="profileHeaderName">Loading...</h1>
                <p class="lead" id="profileHeaderUsername">@loading...</p>
            </div>

            <div class="profile-body">
                <div id="message" class="mb-3"></div>

                <!-- Personal Information Section -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-user-circle"></i> Personal Information</h3>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" disabled />
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" disabled />
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" id="saveProfileBtn">Save Name</button>
                    </div>
                </div>

                <!-- Change Email Section -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-envelope"></i> Change Email Address</h3>
                    <div class="mb-3">
                        <label for="currentEmailForChange" class="form-label">Current Email Address</label>
                        <input type="email" class="form-control" id="currentEmailForChange" disabled />
                    </div>
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">New Email Address</label>
                        <input type="email" class="form-control" id="newEmail" placeholder="Enter your new email">
                    </div>
                    <div class="mb-3">
                        <label for="currentPasswordForEmail" class="form-label">Confirm with Password</label>
                        <input type="password" class="form-control" id="currentPasswordForEmail" placeholder="Enter your current password">
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-primary" id="changeEmailBtn">Update Email</button>
                    </div>
                </div>

                <!-- Change Password Section -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-key"></i> Change Password</h3>
                    <div class="mb-3">
                        <label for="oldPassword" class="form-label">Old Password</label>
                        <input type="password" class="form-control" id="oldPassword">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmNewPassword">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="updatePasswordBtn">Update Password</button>
                    </div>
                </div>

                <!-- Delete Account Section -->
                <div class="form-section">
                    <h3 class="section-title text-danger"><i class="fas fa-trash-alt"></i> Account Actions</h3>
                    <p class="text-muted">Once your account is deleted, all of its resources and data will be permanently lost. Please be certain.</p>
                    <div class="action-buttons">
                         <!-- NEW LOGOUT BUTTON ADDED HERE -->
                         <button class="btn btn-secondary" id="logoutBtn">Logout</button>
                         <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">Delete Account</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Account Confirmation Modal -->
    <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Account Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete your account? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete My Account</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- DOM ELEMENTS ---
        const messageDiv = document.getElementById('message');
        const profileHeaderName = document.getElementById('profileHeaderName');
        const profileHeaderUsername = document.getElementById('profileHeaderUsername');
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');
        const newEmailInput = document.getElementById('newEmail');
        const currentPasswordForEmailInput = document.getElementById('currentPasswordForEmail');
        const oldPasswordInput = document.getElementById('oldPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const currentEmailForChangeInput = document.getElementById('currentEmailForChange');

        // --- BUTTONS ---
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const changeEmailBtn = document.getElementById('changeEmailBtn');
        const updatePasswordBtn = document.getElementById('updatePasswordBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const logoutBtn = document.getElementById('logoutBtn'); // NEW: Get the logout button

        const riderId = localStorage.getItem('riderId');

        // --- HELPER FUNCTIONS ---
        function displayMessage(type, text) {
            messageDiv.innerHTML = `<div class="alert alert-${type}">${text}</div>`;
            window.scrollTo(0, 0);
            setTimeout(() => messageDiv.innerHTML = '', 4000);
        }

        async function apiFetch(endpoint, method, body = null) {
            const headers = {
                'Content-Type': 'application/json'
            };
            const options = { method, headers };
            if (body) {
                // Add rider_id to the body for all requests
                body.rider_id = riderId;
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(endpoint, options);
            if (response.status === 204) return { ok: true }; // Handle no-content responses like DELETE

            const data = await response.json();
            if (!response.ok) {
                const errorMsg = Object.values(data).flat().join('<br>');
                throw new Error(errorMsg || `Request failed with status ${response.status}`);
            }
            return { ok: true, data };
        }

        // --- CORE FUNCTIONS ---
        async function loadProfile() {
            if (!riderId) {
                window.location.href = '/';
                return;
            }
            try {
                const response = await fetch(`/api/profile/?rider_id=${riderId}`);
                if (!response.ok) {
                    throw new Error('Failed to load profile');
                }
                const data = await response.json();
                profileHeaderName.textContent = `${data.first_name || ''} ${data.last_name || ''}`.trim();
                profileHeaderUsername.textContent = `@${data.username}`;
                firstNameInput.value = data.first_name || '';
                lastNameInput.value = data.last_name || '';
                usernameInput.value = data.username;
                emailInput.value = data.email;
                currentEmailForChangeInput.value = data.email;
            } catch (error) {
                displayMessage('danger', error.message);
            }
        }

        async function saveProfile() {
            try {
                const { data } = await apiFetch('/api/profile/', 'PATCH', {
                    first_name: firstNameInput.value,
                    last_name: lastNameInput.value
                });
                profileHeaderName.textContent = `${data.first_name} ${data.last_name}`;
                displayMessage('success', 'Profile updated successfully!');
            } catch (error) {
                displayMessage('danger', error.message);
            }
        }

        async function changeEmail() {
            if (!newEmailInput.value || !currentPasswordForEmailInput.value) {
                displayMessage('warning', 'Please fill in both new email and password fields.');
                return;
            }
             try {
                const { data } = await apiFetch('/api/profile/change-email/', 'PUT', {
                    new_email: newEmailInput.value,
                    current_password: currentPasswordForEmailInput.value
                });
                emailInput.value = data.email;
                currentEmailForChangeInput.value = data.email;
                newEmailInput.value = '';
                currentPasswordForEmailInput.value = '';
                displayMessage('success', 'Email updated successfully!');
            } catch (error) {
                displayMessage('danger', error.message);
            }
        }

        async function changePassword() {
            if (newPasswordInput.value !== confirmNewPasswordInput.value) {
                displayMessage('danger', 'New passwords do not match.');
                return;
            }
            try {
                await apiFetch('/api/profile/change-password/', 'PUT', {
                    old_password: oldPasswordInput.value,
                    new_password: newPasswordInput.value,
                    confirm_new_password: confirmNewPasswordInput.value
                });
                oldPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
                displayMessage('success', 'Password updated successfully!');
            } catch (error) {
                displayMessage('danger', error.message);
            }
        }
        
        async function deleteAccount() {
            try {
                const response = await fetch('/api/profile/delete-account/', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({rider_id: riderId})
                });
                if (!response.ok) {
                    throw new Error('Failed to delete account');
                }
                localStorage.removeItem('riderId');
                localStorage.removeItem('username');
                window.location.href = '/';
            } catch (error) {
                displayMessage('danger', `Failed to delete account: ${error.message}`);
            }
        }

        // NEW: Logout Function
        function logout() {
            localStorage.removeItem('riderId');
            localStorage.removeItem('username');
            window.location.href = '/'; // Redirect to login page
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', loadProfile);
        saveProfileBtn.addEventListener('click', saveProfile);
        changeEmailBtn.addEventListener('click', changeEmail);
        updatePasswordBtn.addEventListener('click', changePassword);
        confirmDeleteBtn.addEventListener('click', deleteAccount);
        logoutBtn.addEventListener('click', logout); // NEW: Add click listener for logout
    </script>
</body>
</html>```