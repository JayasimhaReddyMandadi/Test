<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ExpenseTracker Pro - Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
body { background-color: #f5f7fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
.navbar { background-color: #003087; }
.navbar-brand, .nav-link, .navbar-text { color: #fff !important; }
.dashboard-container { padding: 40px; }
.card { border: none; border-radius: 16px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); transition: all 0.3s ease; }
.card:hover { transform: translateY(-3px); box-shadow: 0 12px 24px rgba(0,0,0,0.08); }
.card-icon { font-size: 2rem; color: white; padding: 12px; border-radius: 10px; }
.bg-income { background: linear-gradient(135deg, #28a745, #218838); }
.bg-expense { background: linear-gradient(135deg, #dc3545, #c82333); }
.bg-savings { background: linear-gradient(135deg, #17a2b8, #117a8b); }
.bg-balance { background: linear-gradient(135deg, #ffc107, #e0a800); }
.quick-action-card { text-align: center; padding: 20px; border-radius: 12px; cursor: pointer; background: white; transition: all 0.3s ease; }
.quick-action-card:hover { background: #e9f2ff; transform: translateY(-3px); }
.recent-transactions, .income-sources { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
.btn-view-all { float: right; font-size: 0.9rem; color: #007bff; text-decoration: none; }
.btn-view-all:hover { text-decoration: underline; }
.modal-header { background-color: #003087; color: white; border-top-left-radius: 10px; border-top-right-radius: 10px; }
.form-control:focus { border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
.tx-date { font-size: 0.8rem; color: #6c757d; }
</style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg">
<div class="container-fluid">
  <a class="navbar-brand fw-bold" href="#"><i class="bi bi-wallet2 me-2"></i>ExpenseTracker Pro</a>
  <div class="d-flex">
    <span class="navbar-text me-3">Welcome, <strong id="username">User</strong></span>
    <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
  </div>
</div>
</nav>

<!-- Dashboard Content -->
<div class="dashboard-container container-fluid">
  <!-- Summary Cards -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="card p-3">
        <div class="d-flex align-items-center">
          <div class="card-icon bg-income me-3"><i class="bi bi-cash-stack"></i></div>
          <div>
            <h6 class="text-muted mb-1">Total Income</h6>
            <h4 class="mb-0" id="totalIncome">₹0</h4>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div class="d-flex align-items-center">
          <div class="card-icon bg-expense me-3"><i class="bi bi-credit-card"></i></div>
          <div>
            <h6 class="text-muted mb-1">Total Expense</h6>
            <h4 class="mb-0" id="totalExpense">₹0</h4>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div class="d-flex align-items-center">
          <div class="card-icon bg-savings me-3"><i class="bi bi-piggy-bank"></i></div>
          <div>
            <h6 class="text-muted mb-1">Total Savings</h6>
            <h4 class="mb-0" id="totalSavings">₹0</h4>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div class="d-flex align-items-center">
          <div class="card-icon bg-balance me-3"><i class="bi bi-wallet2"></i></div>
          <div>
            <h6 class="text-muted mb-1">Balance</h6>
            <h4 class="mb-0" id="balance">₹0</h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="quick-action-card" data-bs-toggle="modal" data-bs-target="#addIncomeModal">
        <i class="bi bi-plus-circle text-success fs-3 mb-2"></i>
        <h6>Add Income</h6>
      </div>
    </div>
    <div class="col-md-4">
      <div class="quick-action-card" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
        <i class="bi bi-dash-circle text-danger fs-3 mb-2"></i>
        <h6>Add Expense</h6>
      </div>
    </div>
    <div class="col-md-4">
      <div class="quick-action-card" onclick="viewReport()">
        <i class="bi bi-bar-chart text-primary fs-3 mb-2"></i>
        <h6>View Report</h6>
      </div>
    </div>
  </div>

  <!-- Recent Transactions -->
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="recent-transactions">
        <h5>Recent Transactions <a href="#" class="btn-view-all">View All</a></h5>
        <hr>
        <ul class="list-group list-group-flush" id="recentTransactionsList">
          <!-- Transactions will load dynamically -->
        </ul>
      </div>
    </div>

    <!-- Income Sources -->
    <div class="col-lg-4">
      <div class="income-sources">
        <h5>Income Sources</h5>
        <hr>
        <ul class="list-group list-group-flush" id="incomeSourcesList">
          <!-- Income sources loaded dynamically -->
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Add Income Modal -->
<div class="modal fade" id="addIncomeModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
  <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add Income</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="addIncomeForm">
  <div class="mb-3">
    <label class="form-label">Source</label>
    <input type="text" id="incomeSource" class="form-control" placeholder="e.g. Salary" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Amount (₹)</label>
    <input type="number" id="incomeAmount" class="form-control" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Date</label>
    <input type="date" id="incomeDate" class="form-control" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Notes</label>
    <textarea id="incomeNotes" class="form-control" rows="2"></textarea>
  </div>
</form>
</div>
<div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  <button type="button" class="btn btn-primary" onclick="saveIncome()">Save Income</button>
</div>
</div>
</div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
  <h5 class="modal-title"><i class="bi bi-dash-circle me-2"></i>Add Expense</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="addExpenseForm">
  <div class="mb-3">
    <label class="form-label">Category</label>
    <input type="text" id="expenseCategory" class="form-control" placeholder="e.g. Groceries" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Amount (₹)</label>
    <input type="number" id="expenseAmount" class="form-control" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Date</label>
    <input type="date" id="expenseDate" class="form-control" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Notes</label>
    <textarea id="expenseNotes" class="form-control" rows="2"></textarea>
  </div>
</form>
</div>
<div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  <button type="button" class="btn btn-danger" onclick="saveExpense()">Save Expense</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// THIS IS THE CORRECTED PART. IT NOW WORKS EVERYWHERE.
const API_BASE = '/api';

const riderId = localStorage.getItem('riderId');
if(!riderId) window.location.href='/';

// Set username
document.getElementById('username').innerText = localStorage.getItem('username') || 'User';

// Dashboard
function loadDashboard(){
  fetch(`${API_BASE}/dashboard/?rider_id=${riderId}`)
  .then(res=>res.json())
  .then(data=>{
    if(data.error) {
      alert('Error loading dashboard: ' + data.error);
      return;
    }
    document.getElementById('totalIncome').innerText = `₹${data.total_income}`;
    document.getElementById('totalExpense').innerText = `₹${data.total_expense}`;
    document.getElementById('totalSavings').innerText = `₹${data.total_saving}`;
    document.getElementById('balance').innerText = `₹${data.balance}`;
  }).catch(error => {
    console.error('Error loading dashboard:', error);
  });
}

// Recent Transactions
function loadRecentTransactions(){
  fetch(`${API_BASE}/transactions/recent/?rider_id=${riderId}`)
  .then(res=>res.json())
  .then(data=>{
    if(data.error) {
      console.error('Error loading transactions:', data.error);
      return;
    }
    const list = document.getElementById('recentTransactionsList');
    const incomeList = document.getElementById('incomeSourcesList');
    list.innerHTML = '';
    incomeList.innerHTML = '';
    if (!data.transactions || data.transactions.length === 0) {
        list.innerHTML = '<li class="list-group-item">No recent transactions.</li>';
        return;
    }
    data.transactions.forEach(tx=>{
      const amount=parseFloat(tx.amount);
      const isIncome = tx.source?true:false;
      const displayName=tx.source||tx.category;
      const displayDate=new Date(tx.created_at).toLocaleString();
      // Recent Transactions
      const li=document.createElement('li');
      li.className='list-group-item d-flex justify-content-between flex-column';
      li.innerHTML=`
        <div class="d-flex justify-content-between">
          <span>${displayName}</span>
          <strong class="${isIncome?'text-success':'text-danger'}">
            ${isIncome?'+':'-'} ₹${amount.toFixed(2)}
          </strong>
        </div>
        <div class="tx-date">Added on: ${displayDate}</div>
      `;
      list.appendChild(li);
      // Income Sources
      if(isIncome){
        let incLi = document.createElement('li');
        incLi.className='list-group-item d-flex justify-content-between';
        incLi.innerHTML=`<span>${tx.source}</span><strong>₹${amount.toFixed(2)}</strong>`;
        incomeList.appendChild(incLi);
      }
    });
  });
}

function refreshDashboardAndTransactions(){
  loadDashboard();
  loadRecentTransactions();
}

document.addEventListener('DOMContentLoaded',()=>{
  refreshDashboardAndTransactions();
});

function logout(){
    localStorage.removeItem('riderId');
    localStorage.removeItem('username');
    window.location.href='/';
}

function saveIncome(){
  const source = document.getElementById('incomeSource').value.trim();
  const amount = parseFloat(document.getElementById('incomeAmount').value.trim());
  const date = document.getElementById('incomeDate').value;
  const notes = document.getElementById('incomeNotes').value.trim();
  if(!source || isNaN(amount) || !date) return alert('Please fill all required fields correctly.');
  fetch(`${API_BASE}/income/add/`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({rider_id: riderId, source, amount, date, notes})
  }).then(res=>{
      if (!res.ok) { throw new Error('Network response was not ok'); }
      return res.json();
  }).then(data=>{
    if(data.message){
      alert('Income added!');
      document.getElementById('addIncomeForm').reset();
      bootstrap.Modal.getInstance(document.getElementById('addIncomeModal')).hide();
      refreshDashboardAndTransactions();
    } else {
      alert('Error adding income: ' + JSON.stringify(data));
    }
  }).catch(error => {
      console.error('Error:', error);
      alert('An error occurred while adding income.');
  });
}

function saveExpense(){
  const category = document.getElementById('expenseCategory').value.trim();
  const amount = parseFloat(document.getElementById('expenseAmount').value.trim());
  const date = document.getElementById('expenseDate').value;
  const notes = document.getElementById('expenseNotes').value.trim();
  if(!category || isNaN(amount) || !date) return alert('Please fill all required fields correctly.');
  fetch(`${API_BASE}/expense/add/`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({rider_id: riderId, category, amount, date, notes})
  }).then(res=>{
      if (!res.ok) { throw new Error('Network response was not ok'); }
      return res.json();
  }).then(data=>{
    if(data.message){
      alert('Expense added!');
      document.getElementById('addExpenseForm').reset();
      bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
      refreshDashboardAndTransactions();
    } else {
      alert('Error adding expense: ' + JSON.stringify(data));
    }
  }).catch(error => {
      console.error('Error:', error);
      alert('An error occurred while adding expense.');
  });
}

function viewReport(){ alert('Report page coming soon!'); }
</script>
</body>
</html>